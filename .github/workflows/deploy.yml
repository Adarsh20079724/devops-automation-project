name: Deploy Application

on:
  push:
    branches:
      - main

  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'eu-north-1' }}

      - name: Check if EC2 Instance Exists
        id: check_ec2
        run: |
          echo "Checking for EC2 instance in AWS..."

          # Query AWS for running EC2 instances with our tag
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=devops-automation-server" \
                      "Name=instance-state-name,Values=running,pending" \
            --query "Reservations[0].Instances[0].InstanceId" \
            --output text 2>/dev/null)

          if [ "$INSTANCE_ID" == "None" ] || [ -z "$INSTANCE_ID" ]; then
            echo ""
            echo "========================================="
            echo "ERROR: EC2 instance not found!"
            echo "========================================="
            echo ""        
            echo "Please follow the next steps:"
            echo "  1. Go to the 'Actions' tab in your repository"
            echo "  2. Click on 'Provision Infrastructure' workflow"
            echo "  3. Click 'Run workflow' button"
            echo "  4. Select 'apply' from the dropdown"
            echo "  5. Click 'Run workflow' to start"
            echo "  6. Wait for completion"
            echo "  7. Wait additional 2-3 minutes for EC2 to boot"
            echo "  8. Make a push to origin to automatically trigger deployment or run this flow again manually"
            echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            exit 1
          fi

          echo "EC2 instance Found: $INSTANCE_ID"
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT

      - name: Get EC2 Public IP
        id: ec2_ip
        run: |
          echo "Getting EC2 public IP address..."

          # Get public IP from AWS
          EC2_IP=$(aws ec2 describe-instances \
            --instance-ids ${{ steps.check_ec2.outputs.instance_id }} \
            --query "Reservations[0].Instances[0].PublicIpAddress" \
            --output text)

          # Validate IP format
          if [[ ! "$EC2_IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Invalid or missing EC2 IP address: $EC2_IP"
            echo "The instance might still be starting. Wait a moment and try again."
            exit 1
          fi

          echo "ip=$EC2_IP" >> $GITHUB_OUTPUT
          echo "EC2 Public IP: $EC2_IP"

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key.pem
          chmod 600 ~/.ssh/deploy_key.pem
          echo "SSH key created successfully"

      - name: Test SSH Connection
        run: |
          echo "Testing SSH connection to ${{ steps.ec2_ip.outputs.ip }}"
          for i in {1..5}; do
            if ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no -o ConnectTimeout=10 ubuntu@${{ steps.ec2_ip.outputs.ip }} "echo 'SSH connection successful'"; then
              echo "SSH connection established"
              exit 0
            fi
            echo "Attempt $i failed, waiting 10 seconds..."
            sleep 10
          done
          echo "Failed to establish SSH connection after 5 attempts"
          echo "Make sure the EC2 instance is running and security group allows SSH"
          exit 1

      - name: Update Ansible Inventory
        run: |
          echo "[webservers]" > ansible/inventory.ini
          echo "${{ steps.ec2_ip.outputs.ip }} ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/deploy_key.pem ansible_ssh_common_args='-o StrictHostKeyChecking=no'" >> ansible/inventory.ini
          cat ansible/inventory.ini

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Ansible
        run: |
          pip install ansible

      - name: Run Ansible Playbook
        working-directory: ./ansible
        run: |
          ansible-playbook -i inventory.ini playbook.yml -v
        env:
          ANSIBLE_HOST_KEY_CHECKING: False

      - name: Display Application URL
        run: |
          echo "Your Application has been Deployed Succcessfully."
          echo "Access your app at: http://${{ steps.ec2_ip.outputs.ip }}"
          echo ""
          echo "=====Deployment Details====="
          echo "- Deployment Time: $(date)"
          echo "- Triggered by: ${{ github.actor }}"
          echo "- Commit: ${{ github.sha }}"
