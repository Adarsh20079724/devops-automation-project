name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: eu-north-1

jobs:
  terraform:
    name: Provision Infrastructure
    runs-on: ubuntu-latest
    outputs:
      instance_ip: ${{ steps.terraform_output.outputs.instance_ip }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: Terraform Plan
        working-directory: ./terraform
        run: terraform plan -var="public_key=${{ secrets.SSH_PUBLIC_KEY }}"

      - name: Terraform Apply
        working-directory: ./terraform
        run: terraform apply -auto-approve -var="public_key=${{ secrets.SSH_PUBLIC_KEY }}"

      - name: Get Terraform Outputs
        id: terraform_output
        working-directory: ./terraform
        run: |
          INSTANCE_IP=$(terraform output -raw instance_public_ip)
          echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
          echo "Instance IP: $INSTANCE_IP"

  deploy:
    name: Deploy Application
    needs: terraform
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for EC2 Initial Boot
        run: |
          echo "Waiting 180 seconds for EC2 instance to boot..."
          sleep 180

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/devops-automation-key
          chmod 600 ~/.ssh/devops-automation-key
          ssh-keyscan -H ${{ needs.terraform.outputs.instance_ip }} >> ~/.ssh/known_hosts

      - name: Wait for EC2 Initialization to Complete
        env:
          INSTANCE_IP: ${{ needs.terraform.outputs.instance_ip }}
        run: |
          echo "Checking if EC2 initialization is complete..."
          
          # Wait for cloud-init to finish
          for i in {1..30}; do
            echo "Attempt $i/30: Checking cloud-init status..."
            
            STATUS=$(ssh -i ~/.ssh/devops-automation-key -o StrictHostKeyChecking=no -o ConnectTimeout=10 ubuntu@$INSTANCE_IP \
              "cloud-init status 2>/dev/null || echo 'not-ready'" || echo "ssh-failed")
            
            echo "Status: $STATUS"
            
            if [[ "$STATUS" == *"done"* ]] || [[ "$STATUS" == *"disabled"* ]]; then
              echo "‚úÖ Cloud-init completed!"
              break
            elif [ "$i" -eq 30 ]; then
              echo "‚ö†Ô∏è Cloud-init still running, but proceeding..."
              break
            else
              echo "‚è≥ Still initializing, waiting 20 seconds..."
              sleep 20
            fi
          done
          
          # Verify Docker is installed
          echo "Verifying Docker installation..."
          for i in {1..10}; do
            if ssh -i ~/.ssh/devops-automation-key -o StrictHostKeyChecking=no ubuntu@$INSTANCE_IP "docker --version" 2>/dev/null; then
              echo "‚úÖ Docker is ready!"
              break
            else
              echo "‚è≥ Docker not ready yet, waiting 15 seconds..."
              sleep 15
            fi
          done
          
          # Verify Git is installed
          if ssh -i ~/.ssh/devops-automation-key -o StrictHostKeyChecking=no ubuntu@$INSTANCE_IP "git --version" 2>/dev/null; then
            echo "‚úÖ Git is ready!"
          else
            echo "‚ùå Git not found!"
            exit 1
          fi

      - name: Deploy to EC2
        env:
          INSTANCE_IP: ${{ needs.terraform.outputs.instance_ip }}
        run: |
          ssh -i ~/.ssh/devops-automation-key -o StrictHostKeyChecking=no ubuntu@$INSTANCE_IP << 'EOF'
            set -e  # Exit on any error
            
            echo "üìÅ Creating app directory..."
            mkdir -p /home/ubuntu/app
            cd /home/ubuntu/app
            
            echo "üóëÔ∏è Removing old code..."
            rm -rf devops-automation-project
            
            echo "üì• Cloning repository..."
            git clone https://github.com/${{ github.repository }}.git
            cd devops-automation-project
            
            echo "üê≥ Stopping old containers..."
            docker compose down 2>/dev/null || true
            
            echo "üßπ Cleaning Docker resources..."
            docker system prune -af
            
            echo "üèóÔ∏è Building and starting containers..."
            docker compose up -d --build
            
            echo "‚è≥ Waiting for containers to start..."
            sleep 20
            
            echo "üìä Container status:"
            docker ps
            
            echo "üìù Container logs:"
            docker logs devops-app --tail 50 || true
            
            echo "‚úÖ Deployment completed!"
          EOF

      - name: Verify Deployment
        env:
          INSTANCE_IP: ${{ needs.terraform.outputs.instance_ip }}
        run: |
          echo "Waiting 30 seconds for application to fully start..."
          sleep 30
          
          echo "Testing application endpoints..."
          
          # Test health endpoint
          for i in {1..10}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://$INSTANCE_IP:5000/api/health || echo "000")
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "‚úÖ Application is running successfully!"
              echo "üåç Access your app at: http://$INSTANCE_IP:5000"
              exit 0
            else
              echo "‚è≥ Attempt $i/10: Health check returned $HTTP_STATUS, waiting 10 seconds..."
              sleep 10
            fi
          done
          
          echo "‚ö†Ô∏è Application health check failed after 10 attempts"
          echo "Check manually at: http://$INSTANCE_IP:5000"
          
          # Show container logs for debugging
          echo "üìù Fetching container logs for debugging..."
          ssh -i ~/.ssh/devops-automation-key -o StrictHostKeyChecking=no ubuntu@$INSTANCE_IP \
            "docker logs devops-app --tail 100" || true

      - name: Deployment Summary
        if: always()
        run: |
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Infrastructure provisioned successfully" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Application deployment attempted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üåê Access Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Application URL:** http://${{ needs.terraform.outputs.instance_ip }}:5000" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Check:** http://${{ needs.terraform.outputs.instance_ip }}:5000/api/health" >> $GITHUB_STEP_SUMMARY
          echo "- **Instance IP:** ${{ needs.terraform.outputs.instance_ip }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîç Debugging" >> $GITHUB_STEP_SUMMARY
          echo "SSH into server: \`ssh -i ~/.ssh/devops-automation-key ubuntu@${{ needs.terraform.outputs.instance_ip }}\`" >> $GITHUB_STEP_SUMMARY
          echo "Check logs: \`docker logs devops-app\`" >> $GITHUB_STEP_SUMMARY