name: Deploy with Terraform + Ansible

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: eu-north-1
  TF_VAR_create_new_resources: "false"

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/devops-automation-key
          chmod 600 ~/.ssh/devops-automation-key
          
          # Create SSH config for easier connection
          cat > ~/.ssh/config << EOF
          Host devops-server
            HostName ${{ steps.get_ip.outputs.instance_ip }}
            User ubuntu
            IdentityFile ~/.ssh/devops-automation-key
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ServerAliveInterval 30
            ServerAliveCountMax 10
            ConnectTimeout 10
          EOF
          
          chmod 600 ~/.ssh/config

      - name: Wait for EC2 to be Ready
        run: |
          echo "â³ Waiting for EC2 instance to be fully ready..."
          
          INSTANCE_IP="${{ steps.get_ip.outputs.instance_ip }}"
          echo "Instance IP: $INSTANCE_IP"
          
          # Wait for instance to be running
          echo "Checking instance status..."
          aws ec2 wait instance-running \
            --region ${{ env.AWS_REGION }} \
            --filters "Name=tag:Name,Values=devops-automation-server" || true
          
          # Additional wait for system to boot
          echo "Waiting for system to boot (90 seconds)..."
          sleep 90
          
          # Test SSH connection
          echo "Testing SSH connection..."
          MAX_ATTEMPTS=40
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS"
            
            if timeout 10 ssh -i ~/.ssh/devops-automation-key \
               -o StrictHostKeyChecking=no \
               -o UserKnownHostsFile=/dev/null \
               -o ConnectTimeout=10 \
               ubuntu@$INSTANCE_IP "echo 'SSH Connection Successful'" 2>&1; then
              echo "âœ… SSH connection established!"
              
              # Wait for cloud-init to complete
              echo "Waiting for cloud-init to complete..."
              ssh -i ~/.ssh/devops-automation-key \
                  -o StrictHostKeyChecking=no \
                  -o UserKnownHostsFile=/dev/null \
                  ubuntu@$INSTANCE_IP \
                  "cloud-init status --wait" || echo "Cloud-init wait failed, continuing anyway"
              
              exit 0
            else
              echo "SSH not ready yet, waiting 15 seconds..."
              sleep 15
            fi
          done
          
          echo "âŒ Failed to establish SSH connection after $MAX_ATTEMPTS attempts"
          
          # Debug information
          echo "=== Debugging Information ==="
          echo "Instance IP: $INSTANCE_IP"
          
          echo "=== Instance Status ==="
          aws ec2 describe-instances \
            --region ${{ env.AWS_REGION }} \
            --filters "Name=tag:Name,Values=devops-automation-server" \
            --query 'Reservations[0].Instances[0].[InstanceId,State.Name,PublicIpAddress]' \
            --output table || true
          
          echo "=== Security Group Rules (Port 22) ==="
          aws ec2 describe-security-groups \
            --region ${{ env.AWS_REGION }} \
            --filters "Name=group-name,Values=devops-automation-sg" \
            --query 'SecurityGroups[0].IpPermissions[?FromPort==`22`]' \
            --output table || true
          
          exit 1

      - name: Setup Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible
          ansible --version

      - name: Test Ansible Connection
        working-directory: ./ansible
        env:
          EC2_IP: ${{ steps.get_ip.outputs.instance_ip }}
          ANSIBLE_HOST_KEY_CHECKING: "False"
        run: |
          echo "Testing Ansible connection..."
          ansible all -i inventory.yml -m ping -v || echo "Ping failed, but continuing..."

      - name: Run Ansible Playbook
        working-directory: ./ansible
        env:
          EC2_IP: ${{ steps.get_ip.outputs.instance_ip }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ANSIBLE_HOST_KEY_CHECKING: "False"
        run: |
          ansible-playbook deploy-playbook.yml -i inventory.yml -v

      - name: Verify Deployment
        run: |
          echo "ðŸ” Verifying deployment..."
          
          for i in {1..10}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ steps.get_ip.outputs.instance_ip }}/health || echo "000")
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… Application is healthy!"
              exit 0
            else
              echo "â³ Attempt $i/10: Health check returned $HTTP_STATUS"
              sleep 5
            fi
          done
          
          echo "âš ï¸ Health check failed"
          exit 1

      - name: Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Infrastructure provisioned with Terraform" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Application deployed with Ansible" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Access Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Application URL:** http://${{ steps.get_ip.outputs.instance_ip }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Check:** http://${{ steps.get_ip.outputs.instance_ip }}/health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ› ï¸ Technologies Used" >> $GITHUB_STEP_SUMMARY
          echo "- **Terraform:** Infrastructure provisioning" >> $GITHUB_STEP_SUMMARY
          echo "- **Ansible:** Configuration management & deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker:** Application containerization" >> $GITHUB_STEP_SUMMARY
          echo "- **Nginx:** Web server" >> $GITHUB_STEP_SUMMARY