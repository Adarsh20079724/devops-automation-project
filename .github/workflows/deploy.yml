name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: eu-north-1

jobs:
  terraform:
    name: Provision Infrastructure
    runs-on: ubuntu-latest
    outputs:
      instance_ip: ${{ steps.terraform_output.outputs.instance_ip }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: Terraform Plan
        working-directory: ./terraform
        run: terraform plan -var="public_key=${{ secrets.SSH_PUBLIC_KEY }}"

      - name: Terraform Apply
        working-directory: ./terraform
        run: terraform apply -auto-approve -var="public_key=${{ secrets.SSH_PUBLIC_KEY }}"

      - name: Get Terraform Outputs
        id: terraform_output
        working-directory: ./terraform
        run: |
          INSTANCE_IP=$(terraform output -raw instance_public_ip)
          echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
          echo "Instance IP: $INSTANCE_IP"

  deploy:
    name: Deploy Application
    needs: terraform
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for EC2 to be ready
        run: |
          echo "Waiting 90 seconds for EC2 instance to initialize..."
          sleep 90

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/devops-automation-key
          chmod 600 ~/.ssh/devops-automation-key
          ssh-keyscan -H ${{ needs.terraform.outputs.instance_ip }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          INSTANCE_IP: ${{ needs.terraform.outputs.instance_ip }}
        run: |
          ssh -i ~/.ssh/devops-automation-key -o StrictHostKeyChecking=no ubuntu@$INSTANCE_IP << 'EOF'
            # Navigate to app directory
            cd /home/ubuntu/app
            
            # Remove old code if exists
            rm -rf devops-automation-project
            
            # Clone the repository
            git clone https://github.com/${{ github.repository }}.git
            cd devops-automation-project
            
            # Stop and remove old containers
            docker compose down || true
            docker system prune -af
            
            # Build and start new containers
            docker compose up -d --build
            
            # Show running containers
            docker ps
            
            echo "âœ… Deployment completed successfully!"
          EOF

      - name: Verify Deployment
        run: |
          echo "Waiting for application to start..."
          sleep 30
          
          INSTANCE_IP=${{ needs.terraform.outputs.instance_ip }}
          
          # Check if app is responding
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://$INSTANCE_IP:5000/api/health || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Application is running successfully!"
            echo "ðŸŒ Access your app at: http://$INSTANCE_IP:5000"
          else
            echo "âš ï¸ Application health check returned status: $HTTP_STATUS"
            echo "The application may still be starting up. Check manually at: http://$INSTANCE_IP:5000"
          fi

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Infrastructure provisioned successfully" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Application deployed to EC2" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Access Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Application URL:** http://${{ needs.terraform.outputs.instance_ip }}:5000" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Check:** http://${{ needs.terraform.outputs.instance_ip }}:5000/api/health" >> $GITHUB_STEP_SUMMARY
          echo "- **Instance IP:** ${{ needs.terraform.outputs.instance_ip }}" >> $GITHUB_STEP_SUMMARY
          