---
- name: Check if Security Group exists
  amazon.aws.ec2_security_group_info:
    region: "{{ aws_region }}"
    filters:
      group-name: "{{ security_group_name }}"
  register: sg_info

- name: Create Security Group if it doesn't exist
  amazon.aws.ec2_security_group:
    name: "{{ security_group_name }}"
    description: "Security group for {{ project_name }}"
    region: "{{ aws_region }}"
    rules:
      - proto: tcp
        ports: 22
        cidr_ip: 0.0.0.0/0
        rule_desc: "SSH access"
      - proto: tcp
        ports: "{{ app_port }}"
        cidr_ip: 0.0.0.0/0
        rule_desc: "Application access"
    rules_egress:
      - proto: all
        cidr_ip: 0.0.0.0/0
    tags:
      Name: "{{ security_group_name }}"
      Project: "{{ project_name }}"
  when: sg_info.security_groups | length == 0
  register: security_group

- name: Set security group ID
  set_fact:
    sg_id: "{{ sg_info.security_groups[0].group_id if sg_info.security_groups | length > 0 else security_group.group_id }}"

- name: Check if Key Pair exists
  amazon.aws.ec2_key_info:
    names:
      - "{{ key_name }}"
    region: "{{ aws_region }}"
  register: key_info
  ignore_errors: yes

- name: Create Key Pair if it doesn't exist
  amazon.aws.ec2_key:
    name: "{{ key_name }}"
    key_material: "{{ lookup('env', 'SSH_PUBLIC_KEY') }}"
    region: "{{ aws_region }}"
    tags:
      Name: "{{ key_name }}"
      Project: "{{ project_name }}"
  when: key_info.keypairs | length == 0

- name: Check if EC2 instance exists
  amazon.aws.ec2_instance_info:
    region: "{{ aws_region }}"
    filters:
      "tag:Name": "{{ instance_name }}"
      "instance-state-name": running
  register: ec2_info

- name: Create EC2 instance if it doesn't exist
  amazon.aws.ec2_instance:
    name: "{{ instance_name }}"
    region: "{{ aws_region }}"
    instance_type: "{{ instance_type }}"
    image_id: "{{ ami_id }}"
    key_name: "{{ key_name }}"
    security_group: "{{ sg_id }}"
    network:
      assign_public_ip: true
    volumes:
      - device_name: /dev/sda1
        ebs:
          volume_size: 20
          volume_type: gp3
          delete_on_termination: true
    user_data: |
      #!/bin/bash
      set -e
      apt-get update -y
      apt-get upgrade -y
      
      # Install Docker
      apt-get install -y ca-certificates curl gnupg lsb-release
      mkdir -p /etc/apt/keyrings
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
      apt-get update -y
      apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
      
      systemctl start docker
      systemctl enable docker
      usermod -aG docker ubuntu
      
      # Install Git
      apt-get install -y git
      
      # Create app directory
      mkdir -p /home/ubuntu/app
      chown ubuntu:ubuntu /home/ubuntu/app
      
      echo "Setup complete" > /var/log/user-data-complete
    tags:
      Name: "{{ instance_name }}"
      Project: "{{ project_name }}"
    wait: yes
    wait_timeout: 300
  when: ec2_info.instances | length == 0
  register: ec2_instance

- name: Set instance info
  set_fact:
    instance_id: "{{ ec2_info.instances[0].instance_id if ec2_info.instances | length > 0 else ec2_instance.instances[0].instance_id }}"
    instance_ip: "{{ ec2_info.instances[0].public_ip_address if ec2_info.instances | length > 0 else ec2_instance.instances[0].public_ip_address }}"

- name: Wait for EC2 to be ready (if newly created)
  wait_for:
    host: "{{ instance_ip }}"
    port: 22
    delay: 30
    timeout: 300
  when: ec2_info.instances | length == 0

- name: Wait for cloud-init to complete
  command: >
    ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
    -i ~/.ssh/devops-automation-key ubuntu@{{ instance_ip }}
    'cloud-init status --wait'
  register: cloud_init
  retries: 30
  delay: 10
  until: cloud_init.rc == 0
  when: ec2_info.instances | length == 0

- name: Display instance information
  debug:
    msg:
      - "Instance ID: {{ instance_id }}"
      - "Instance IP: {{ instance_ip }}"
      - "Application URL: http://{{ instance_ip }}"