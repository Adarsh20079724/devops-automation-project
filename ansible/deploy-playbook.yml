---
- name: Deploy DevOps Application
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    app_name: devops-app
    app_dir: /home/ubuntu/app/devops-automation-project
    github_repo: "https://github.com/{{ lookup('env', 'GITHUB_REPOSITORY') }}.git"

  tasks:
    - name: Wait for cloud-init to complete
      command: cloud-init status --wait
      changed_when: false
      failed_when: false

    - name: Ensure Docker is installed
      apt:
        name:
          - docker.io
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Ensure Docker service is running
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Add ubuntu user to docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    - name: Ensure Git is installed
      apt:
        name: git
        state: present

    - name: Create app directory
      file:
        path: /home/ubuntu/app
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Remove old application code
      file:
        path: "{{ app_dir }}"
        state: absent

    - name: Clone application repository
      git:
        repo: "{{ github_repo }}"
        dest: "{{ app_dir }}"
        version: main
        force: yes
      become_user: ubuntu

    - name: Stop existing containers
      docker_compose:
        project_src: "{{ app_dir }}"
        state: absent
      become_user: ubuntu
      ignore_errors: yes

    - name: Prune Docker system
      docker_prune:
        containers: yes
        images: yes
        networks: yes
        volumes: yes
        builder_cache: yes
      become_user: ubuntu

    - name: Build and start Docker containers
      docker_compose:
        project_src: "{{ app_dir }}"
        build: yes
        pull: yes
        state: present
      become_user: ubuntu
      register: docker_result

    - name: Wait for application to be ready
      wait_for:
        host: localhost
        port: 80
        delay: 10
        timeout: 60

    - name: Check application health
      uri:
        url: "http://localhost/health"
        status_code: 200
      retries: 5
      delay: 5
      register: health_check

    - name: Display container status
      command: docker ps
      become_user: ubuntu
      register: container_status
      changed_when: false

    - name: Show deployment result
      debug:
        msg: "âœ… Deployment successful! Containers running: {{ container_status.stdout_lines }}"